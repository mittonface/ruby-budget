<%= turbo_frame_tag "account_detail" do %>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <% if @account.is_a?(Mortgage) %>
    <!-- Mortgage-specific view -->
    <div class="mb-6">
      <div class="flex justify-between items-start">
        <h1 class="text-3xl font-bold text-gray-900"><%= @account.name %></h1>
        <div class="space-x-2">
          <%= link_to "Edit", edit_account_path(@account), data: { turbo_frame: "_top" }, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Loan Details -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Loan Details</h2>
        <dl class="space-y-2">
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Original Principal:</dt>
            <dd class="text-sm font-medium text-gray-900"><%= number_to_currency(@account.principal) %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Interest Rate:</dt>
            <dd class="text-sm font-medium text-gray-900"><%= @account.interest_rate %>%</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Term:</dt>
            <dd class="text-sm font-medium text-gray-900"><%= @account.term_years %> years</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Start Date:</dt>
            <dd class="text-sm font-medium text-gray-900"><%= @account.loan_start_date.strftime("%B %d, %Y") %></dd>
          </div>
        </dl>
      </div>

      <!-- Current Status -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Current Status</h2>
        <dl class="space-y-2">
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Remaining Balance:</dt>
            <dd class="text-sm font-medium text-red-600"><%= number_to_currency(@account.balance) %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Monthly Payment:</dt>
            <dd class="text-sm font-medium text-gray-900"><%= number_to_currency(@monthly_payment) %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Estimated Payoff:</dt>
            <dd class="text-sm font-medium text-gray-900"><%= @payoff_date.strftime("%B %Y") %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Next Payment Breakdown:</dt>
            <dd class="text-sm text-gray-600">
              Principal: <%= number_to_currency(@payment_breakdown[:principal_portion]) %><br>
              Interest: <%= number_to_currency(@payment_breakdown[:interest_portion]) %>
            </dd>
          </div>
        </dl>
      </div>
    </div>

    <!-- Amortization Schedule -->
    <div class="bg-white shadow rounded-lg p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Amortization Schedule</h2>
      <p class="text-gray-600 mb-4">Balance over time (next 12 months)</p>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Starting Balance</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Principal</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Interest</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ending Balance</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @amortization_schedule.first(12).each do |payment| %>
              <tr>
                <td class="px-4 py-2 text-sm text-gray-900"><%= payment[:month] %></td>
                <td class="px-4 py-2 text-sm text-right text-gray-900"><%= number_to_currency(payment[:starting_balance]) %></td>
                <td class="px-4 py-2 text-sm text-right text-gray-900"><%= number_to_currency(payment[:principal_payment]) %></td>
                <td class="px-4 py-2 text-sm text-right text-gray-600"><%= number_to_currency(payment[:interest_payment]) %></td>
                <td class="px-4 py-2 text-sm text-right font-medium text-gray-900"><%= number_to_currency(payment[:ending_balance]) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex space-x-4 mb-8">
      <%= link_to "Record Payment", new_account_adjustment_path(@account), data: { turbo_frame: "_top" }, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" %>
      <%= link_to "Extra Payment Scenarios", edit_account_projection_path(@account), data: { turbo_frame: "_top" }, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
      <%= button_to "Delete Mortgage", account_path(@account), method: :delete, data: { turbo_confirm: "Are you sure? This will permanently delete this mortgage and all payment history.", turbo_frame: "_top" }, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700" %>
    </div>

  <% else %>
    <!-- Savings Account view (existing) -->
    <div class="bg-white shadow-sm rounded-lg p-8 mb-8">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2"><%= @account.name %></h1>
          <div class="text-sm text-gray-500">
            <p>Opened: <%= @account.opened_at.strftime("%B %d, %Y") %></p>
            <p>Initial Balance: <%= number_to_currency(@account.initial_balance) %></p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500 mb-1">Current Balance</p>
          <p class="text-4xl font-bold <%= @account.balance >= 0 ? 'text-green-600' : 'text-red-600' %>">
            <%= number_to_currency(@account.balance) %>
          </p>
        </div>
      </div>

      <div class="flex gap-4">
        <%= link_to "Add Adjustment", new_account_adjustment_path(@account), data: { turbo_frame: "_top" }, class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors" %>
        <%= link_to "Edit Account", edit_account_path(@account), data: { turbo_frame: "_top" }, class: "bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors" %>
        <%= button_to "Delete Account", account_path(@account), method: :delete, data: { turbo_confirm: "Are you sure? This will delete all adjustments." }, class: "bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors" %>
      </div>
    </div>

    <!-- Projection Settings Section -->
    <div class="bg-white shadow-md rounded px-8 pt-6 pb-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">Future Projections</h2>

      <% if @account.projection %>
        <div class="mb-4">
          <p class="text-gray-700">
            <span class="font-semibold">Monthly Contribution:</span>
            <%= number_to_currency(@account.projection.monthly_contribution) %>
          </p>
          <p class="text-gray-700">
            <span class="font-semibold">Expected Annual Return:</span>
            <%= number_to_percentage(@account.projection.annual_return_rate, precision: 2) %>
          </p>
          <% if @account.projection.target_date.present? %>
            <p class="text-gray-700">
              <span class="font-semibold">Projecting Until:</span>
              <%= @account.projection.target_date.strftime("%B %d, %Y") %>
            </p>
          <% end %>
        </div>
        <%= link_to "Edit Projection Settings", edit_account_projection_path(@account), data: { turbo_frame: "_top" }, class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors" %>

        <% if @projection_result %>
          <div class="mt-6">
            <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
              <p class="text-2xl font-bold text-green-800">
                Projected Balance: <%= number_to_currency(@projection_result[:final_balance]) %>
              </p>
              <p class="text-sm text-green-700">as of <%= @account.projection.target_date.strftime("%B %d, %Y") %></p>
            </div>

            <!-- Chart Container -->
            <div class="mb-6">
              <h3 class="text-xl font-bold mb-3">Projection Growth</h3>
              <div
                id="projection-chart"
                data-controller="projection-chart"
                data-projection-chart-data-value="<%= @projection_result[:monthly_breakdown].to_json %>"
                class="bg-white p-4 rounded-lg border border-gray-200"
              ></div>
            </div>

            <!-- Collapsible Monthly Breakdown Table -->
            <details class="bg-gray-50 rounded-lg border border-gray-200">
              <summary class="cursor-pointer px-4 py-3 font-semibold text-gray-700 hover:bg-gray-100 rounded-lg">
                View detailed monthly breakdown
              </summary>
              <div class="px-4 pb-4">
                <div class="overflow-x-auto max-h-96 overflow-y-auto mt-2">
                  <table class="min-w-full bg-white border">
                    <thead class="bg-gray-100 sticky top-0">
                      <tr>
                        <th class="px-4 py-2 border text-left">Date</th>
                        <th class="px-4 py-2 border text-right">Contribution</th>
                        <th class="px-4 py-2 border text-right">Interest Earned</th>
                        <th class="px-4 py-2 border text-right">Balance</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @projection_result[:monthly_breakdown].each do |month| %>
                        <tr class="hover:bg-gray-50">
                          <td class="px-4 py-2 border"><%= month[:date].strftime("%b %Y") %></td>
                          <td class="px-4 py-2 border text-right"><%= number_to_currency(month[:contribution]) %></td>
                          <td class="px-4 py-2 border text-right"><%= number_to_currency(month[:interest]) %></td>
                          <td class="px-4 py-2 border text-right font-semibold"><%= number_to_currency(month[:balance]) %></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            </details>
          </div>
        <% end %>
      <% else %>
        <p class="text-gray-600 mb-4">Set up projection parameters to see future balance estimates.</p>
        <%= link_to "Set Up Projection", edit_account_projection_path(@account), data: { turbo_frame: "_top" }, class: "bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors" %>
      <% end %>
    </div>
  <% end %>

  <!-- Adjustments/Payments History (common to both types) -->
  <div class="bg-white shadow-sm rounded-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">
        <%= @account.is_a?(Mortgage) ? "Payment History" : "Adjustment History" %>
      </h2>
    </div>

    <% if @adjustments.any? %>
      <% running_balance = @account.balance %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Date
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Description
            </th>
            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
              Amount
            </th>
            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
              Running Balance
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @adjustments.each do |adjustment| %>
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <%= adjustment.adjusted_at.strftime("%b %d, %Y %I:%M %p") %>
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">
                <%= adjustment.description.presence || "â€”" %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <span class="font-medium <%= adjustment.amount >= 0 ? 'text-green-600' : 'text-red-600' %>">
                  <%= adjustment.amount >= 0 ? '+' : '' %><%= number_to_currency(adjustment.amount) %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right font-semibold text-gray-900">
                <%= number_to_currency(running_balance) %>
                <% running_balance -= adjustment.amount %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="px-6 py-8 text-center text-gray-500">
        <p>No <%= @account.is_a?(Mortgage) ? "payments" : "adjustments" %> yet. Add your first <%= @account.is_a?(Mortgage) ? "payment" : "adjustment" %> to start tracking changes.</p>
      </div>
    <% end %>
  </div>
  </div>
<% end %>
